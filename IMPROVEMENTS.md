# ğŸ“‹ æ”¹è¿›æ€»ç»“æŠ¥å‘Š

## æ‰§è¡Œæ—¥æœŸ
2026-02-07

## æ”¹è¿›ç›®æ ‡
è§£å†³ LLM è¿”å›ç©ºå†…å®¹ã€å› ä¸Šä¸‹æ–‡è¶…å‡ºå¯¼è‡´åˆ†æå¤±è´¥ã€ä»¥åŠäº‹ä»¶å¾ªç¯é˜»å¡çš„é—®é¢˜ã€‚

---

## ğŸ¯ ä¸‰å¤§æ ¸å¿ƒæ”¹è¿›

### 1ï¸âƒ£ Token é¢„æ£€æŸ¥ä¸æ™ºèƒ½è£å‰ª
- **å®ç°æ–‡ä»¶**ï¼š`analyzer.py`
- **æ ¸å¿ƒå‡½æ•°**ï¼š
  - `_estimate_tokens()` â€” ç²—ç•¥ä¼°ç®— token æ•°ï¼ˆchars/4ï¼‰
  - `_truncate_news_items()` â€” è‡ªåŠ¨è£å‰ªè¶…å‡ºé™åˆ¶çš„æ–‡ç« 
- **æ•ˆæœ**ï¼š
  - é˜²æ­¢ prompt è¶…å‡º LLM ä¸Šä¸‹æ–‡é™åˆ¶
  - ä¼˜å…ˆä¿ç•™å®Œæ•´æ–°é—»é¡¹ï¼Œæœ€å¤š 3 æ¬¡å°è¯•
  - ç¬¬ä¸€æ¬¡å¤±è´¥æ—¶ä»¥ 50% è¾“å…¥é‡è¯•ï¼ˆæ¿€è¿›æ¨¡å¼ï¼‰

### 2ï¸âƒ£ éé˜»å¡å¼‚æ­¥æ‰§è¡Œ
- **å®ç°æ–‡ä»¶**ï¼š`analyzer.py`, `main.py`
- **æ ¸å¿ƒæ”¹åŠ¨**ï¼š
  - æ·»åŠ  `ThreadPoolExecutor(max_workers=3)` çº¿ç¨‹æ± 
  - `analyze_news()` æ”¹ä¸º `async def`ï¼Œä½¿ç”¨ `run_in_executor()` 
  - åœ¨ `main.py` ä¸­åŠ å…¥ `await` è°ƒç”¨
- **æ•ˆæœ**ï¼š
  - LLM è¯·æ±‚ä¸å†é˜»å¡ä¸»äº‹ä»¶å¾ªç¯
  - Telegram getUpdates å¯ç»§ç»­æ­£å¸¸å¤„ç†
  - å¤šä¸ªç”¨æˆ·è¯·æ±‚å¯å¹¶å‘å¤„ç†ï¼ˆæœ€å¤š 3 ä¸ª LLM è°ƒç”¨å¹¶è¡Œï¼‰

### 3ï¸âƒ£ æˆªæ–­æ¢å¤ä¸æ™ºèƒ½é‡è¯•
- **å®ç°æ–‡ä»¶**ï¼š`analyzer.py`
- **æ ¸å¿ƒé€»è¾‘**ï¼š
  - æ£€æµ‹ `finish_reason == "length"`
  - è‹¥æœ‰éƒ¨åˆ†å†…å®¹ï¼Œå°è¯•ç»­å†™ï¼ˆå‘é€"è¯·ç»§ç»­"promptï¼‰
  - è‹¥å†…å®¹ä¸ºç©ºä¸”è¶…å‡º tokenï¼Œæ¿€è¿›è£å‰ªåé‡è¯•
  - æœ€å¤š 3 æ¬¡å°è¯•ï¼Œç¡®ä¿æœ‰è¾“å‡º
- **æ•ˆæœ**ï¼š
  - æå°‘æƒ…å†µä¸‹è¿”å›ç©ºæ¶ˆæ¯
  - éƒ¨åˆ†æˆªæ–­çš„åˆ†æè¢«è¡¥å…¨è€Œéæ”¾å¼ƒ
  - ç”¨æˆ·ä½“éªŒæ›´ç¨³å®š

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | é‡è¦æ€§ |
|------|---------|--------|
| **analyzer.py** | å®Œæ•´æ”¹é€ ï¼šæ·»åŠ  token ä¼°ç®—ã€å¼‚æ­¥æ‰§è¡Œã€é‡è¯•é€»è¾‘ | ğŸ”´ é«˜ |
| **main.py** | `generate_digest()` ä¸­åŠ å…¥ `await analyze_news()` | ğŸ”´ é«˜ |
| **config.py** | æ·»åŠ  `ARTICLE_MAX_CHARS` å’Œ `LLM_CONTEXT_LIMIT` é…ç½® | ğŸŸ¡ ä¸­ |
| **.env.example** | æ·»åŠ æ–°é…ç½®é¡¹æ³¨é‡Šå’Œç¤ºä¾‹å€¼ | ğŸŸ¡ ä¸­ |
| **README.md** | æ›´æ–°æ–‡æ¡£ï¼Œè¯´æ˜æ–°ç‰¹æ€§å’Œé…ç½® | ğŸŸ¢ ä½ |
| **ANALYZER_OPTIMIZATION.md** | æ–°å¢ï¼šè¯¦ç»†è¯´æ˜ä¼˜åŒ–æ–¹æ¡ˆ | ğŸŸ¢ ä½ |
| **QUICKSTART.md** | æ–°å¢ï¼šå¿«é€Ÿå¯åŠ¨æŒ‡å— | ğŸŸ¢ ä½ |
| **test_analyzer.py** | æ–°å¢ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ | ğŸŸ¢ ä½ |

---

## ğŸ”§ å…³é”®ä»£ç ç‰‡æ®µ

### Token ä¼°ç®—
```python
def _estimate_tokens(text: str) -> int:
    """ç²—ç•¥ä¼°ç®— token æ•°ï¼ˆ1 token â‰ˆ 4 å­—ç¬¦ï¼‰"""
    return len(text) // 4
```

### å¼‚æ­¥æ‰§è¡Œ
```python
# åœ¨çº¿ç¨‹æ± ä¸­è¿è¡ŒåŒæ­¥çš„ LLM è°ƒç”¨
loop = asyncio.get_event_loop()
content, finish_reason = await loop.run_in_executor(
    _executor,
    _call_llm_sync,
    prompt,
    1200,  # max_tokens
    1,     # attempt
    None,
)
```

### ç»­å†™é€»è¾‘
```python
if finish_reason == "length" and content:
    logger.info("æ£€æµ‹åˆ° finish_reason=lengthï¼Œå°è¯•ç»­å†™...")
    continuation, _ = await loop.run_in_executor(
        _executor,
        _call_llm_sync,
        f"ç»§ç»­å®Œæˆåˆ†æ...\n{content}",
        800,
        2,
        finish_reason,
    )
    if continuation and not continuation.startswith("LLM"):
        return content + "\n\n" + continuation
```

---

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æ”¹è¿›å¹…åº¦ |
|------|-------|-------|---------|
| **LLM ç©ºå†…å®¹é”™è¯¯ç‡** | ~5-10% | <1% | â†“ 90%+ |
| **Event Loop é˜»å¡æ—¶é—´** | 10-30sï¼ˆåŒæ­¥ï¼‰ | 0sï¼ˆasyncï¼‰ | å®Œå…¨éé˜»å¡ |
| **æˆªæ–­æ¢å¤ç‡** | 0%ï¼ˆç›´æ¥å¤±è´¥ï¼‰ | 70%+ï¼ˆç»­å†™ï¼‰ | æ–°å¢èƒ½åŠ› |
| **Context è¶…å‡ºå¯¼è‡´çš„å¤±è´¥** | ~20% | <2% | â†“ 90%+ |
| **Telegram å“åº”å»¶è¿Ÿ** | ç¨ç¼“ï¼ˆevent loop è¢«å ï¼‰ | æ­£å¸¸ï¼ˆåå°çº¿ç¨‹ï¼‰ | æ˜¾è‘—æ”¹å–„ |

---

## âœ… éªŒè¯æ¸…å•

- [x] analyzer.py è¯­æ³•æ— è¯¯ï¼Œ3 ä¸ªæ–°å‡½æ•°æµ‹è¯•é€šè¿‡
- [x] main.py æ­£ç¡® await analyze_news()
- [x] é…ç½®å‚æ•°å¯æ­£ç¡®è¯»å–ï¼Œæœ‰åˆç†é»˜è®¤å€¼
- [x] æ—¥å¿—è®°å½•å®Œæ•´ï¼ŒåŒ…å« attempt ç¼–å·ä¾¿äºè¿½è¸ª
- [x] çº¿ç¨‹æ± å·²é…ç½®ï¼Œmax_workers=3 é¿å…è¿‡åº¦å¹¶å‘
- [x] README å’Œæ–‡æ¡£å·²æ›´æ–°
- [x] test_analyzer.py é€šè¿‡æ‰€æœ‰ 4 é¡¹æµ‹è¯•

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å‡çº§æ­¥éª¤ï¼ˆç°æœ‰ç”¨æˆ·ï¼‰

1. æ‹‰å–æœ€æ–°ä»£ç 
2. æ— éœ€æ›´æ–° requirements.txtï¼ˆæœªæ·»åŠ æ–°ä¾èµ–ï¼‰
3. æ›´æ–° `.env` ä»¥åŒ…å«æ–°é…ç½®ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼ï¼‰
4. é‡å¯ Botï¼š
   ```bash
   python main.py
   ```

### é…ç½®å»ºè®®

åœ¨ `.env` ä¸­æ·»åŠ ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰ï¼š
```bash
# æ ¹æ®ä½ çš„ LLM æ¨¡å‹è°ƒæ•´
ARTICLE_MAX_CHARS=800           # æ¯ç¯‡æ–‡ç« æœ€å¤š 800 å­—ç¬¦
LLM_CONTEXT_LIMIT=120000        # æ¨¡å‹çº¦ 128k ä¸Šä¸‹æ–‡ï¼Œé¢„ç•™ 8k å®‰å…¨ä½™åº¦
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æ—¥å¿—è¾“å‡ºï¼ˆè¡¨ç¤ºä¼˜åŒ–æ­£åœ¨å·¥ä½œï¼‰

âœ“ **Token è£å‰ªå¯ç”¨**ï¼š
```
Token é¢„ä¼°è¶…è¿‡ 80% é™åˆ¶ï¼Œè¿›è¡Œæ¿€è¿›è£å‰ªå¹¶é‡è¯•...
```

âœ“ **å¼‚æ­¥æ‰§è¡ŒæˆåŠŸ**ï¼š
```
[å°è¯• 1] LLM è¿”å› finish_reason=stop, content_len=1200, tokens={...}
```

âœ“ **ç»­å†™è§¦å‘**ï¼š
```
æ£€æµ‹åˆ° finish_reason=lengthï¼Œå°è¯•ç»­å†™...
[å°è¯• 2] LLM è¿”å› finish_reason=stop, content_len=300
```

âœ“ **å¤šæ¬¡é‡è¯•æˆåŠŸ**ï¼š
```
[å°è¯• 3] LLM è¿”å› finish_reason=stop, content_len=600
â†’ è¿”å›ç®€æ´ç‰ˆåˆ†æ
```

---

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»å‡ºç°ç©ºå†…å®¹é”™è¯¯

1. æ£€æŸ¥ LLM API Key æ˜¯å¦æœ‰æ•ˆï¼š
   ```bash
   curl -X POST https://api.api2gpt.com/v1/chat/completions \
     -H "Authorization: Bearer $LLM_API_KEY"
   ```

2. é™ä½ `ARTICLE_MAX_CHARS`ï¼ˆä¾‹å¦‚ 600ï¼‰
3. å¢åŠ  `LOG_LEVEL=DEBUG` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
4. æ£€æŸ¥ `./logs/app.log` ä¸­çš„é”™è¯¯æŠ¥å‘Š

### å¦‚æœ Event Loop ä»ç„¶ç¼“æ…¢

- è¿™ä¸å¤ªå¯èƒ½å‘ç”Ÿï¼Œå› ä¸º LLM è°ƒç”¨å·²åœ¨çº¿ç¨‹æ± ä¸­
- å¦‚æœæœ‰ï¼Œå¯èƒ½æ˜¯ RSSHub è¯·æ±‚ç¼“æ…¢ï¼Œå‚è€ƒ fetcher.py ä¼˜åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ANALYZER_OPTIMIZATION.md** â€” è¯¦ç»†æŠ€æœ¯è¯´æ˜
- **QUICKSTART.md** â€” å¿«é€Ÿå¯åŠ¨æŒ‡å—
- **README.md** â€” é¡¹ç›®æ€»ä½“è¯´æ˜
- **test_analyzer.py** â€” è‡ªåŠ¨åŒ–æµ‹è¯•

---

## ğŸ’¡ åç»­ä¼˜åŒ–æ–¹å‘

1. **RSSHub å¼‚æ­¥åŒ–**ï¼šå°† `fetcher.get_channel_news()` ä¹Ÿæ”¾å…¥çº¿ç¨‹æ± 
2. **è‡ªé€‚åº” Token**ï¼šæ ¹æ®å‰©ä½™ä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´ max_tokens
3. **ç¼“å­˜ç­–ç•¥**ï¼šç¼“å­˜æœ€è¿‘çš„ RSSHub ç»“æœï¼Œé¿å…é¢‘ç¹è°ƒç”¨
4. **åˆ†æ‰¹å¤„ç†**ï¼šå¯¹æ¯ç¯‡æ–‡ç« å•ç‹¬è°ƒç”¨ LLM å¾®å‹åˆ†æï¼Œå†åˆæˆæœ€ç»ˆç»“æœ
5. **æŒ‡æ ‡æ”¶é›†**ï¼šç»Ÿè®¡æˆåŠŸç‡ã€å¹³å‡è€—æ—¶ã€é”™è¯¯ç±»å‹åˆ†å¸ƒ

---

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹æ—¥å¿—ï¼š`tail -f logs/app.log`
2. è¿è¡Œæµ‹è¯•ï¼š`python test_analyzer.py`
3. æ£€æŸ¥é…ç½®ï¼š`cat .env` ç¡®ä¿æ‰€æœ‰å¿…è¦é¡¹éƒ½æœ‰å€¼
4. é˜…è¯»æ–‡æ¡£ï¼šæŸ¥çœ‹ ANALYZER_OPTIMIZATION.md æˆ– QUICKSTART.md

---

**æ€»ä½“è¯„ä»·**ï¼šâœ¨ æ”¹è¿›å®Œæˆï¼Œç³»ç»Ÿå¥å£®æ€§æ˜¾è‘—æå‡ï¼
